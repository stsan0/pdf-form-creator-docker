<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDF Form Creator and Editor</title>
  <link rel="stylesheet" href="index.css">
</head>
<body>
  <!-- Use the ECMAScript module syntax -->
  <script type = "module">
    import * as pdfjsLib from './pdfjs-dist/build/pdf.mjs';
    import * as pdflib from './pdf-lib/dist/pdf-lib.js';
    
    //  Error: No "GlobalWorkerOptions.workerSrc" specified
    pdfjsLib.GlobalWorkerOptions.workerSrc = './pdfjs-dist/build/pdf.worker.mjs';

    document.getElementById("loadPdfBtn").addEventListener("click", loadPdf)
    document.getElementById("createFormBtn").addEventListener("click", createForm)
    document.getElementById("editFormBtn").addEventListener("click", editForm)
    
    let pdfDoc = null;
    let pdfForm = null;

    async function loadPdf() {
      const fileInput = document.getElementById('pdf-file-input');
      const file = fileInput.files[0];

      if (file) {
        const data = await file.arrayBuffer();
        pdfDoc = await pdfjsLib.getDocument({ data }).promise;
        renderPdf();
        showFieldValues();
      }
    }

    export async function showFieldValues(){
     const fieldsContainer = document.getElementById('fields-container');
     let fieldValues = extractText().then(function(fieldValues){
     console.log(fieldValues);
     //fieldsContainer.innerHTML = (fieldValues);
      fieldsContainer.innerHTML = JSON.stringify(fieldValues, null, 2);
     }
     );
    }

    // get the fieldValues from a PDF form
    async function extractText() {
      var result = {};                
      var pages = pdfDoc.numPages;
      for (var i = 1; i <= pages; i++) {
          var page = await pdfDoc.getPage(i);
          var annotations = await page.getAnnotations();
          for (var j = 0; j < annotations.length; j++) {
              var element = annotations[j];
              // Field Name
              if (element.fieldValue != ""){
                result[element.fieldName] = element.fieldValue;
              }
              // result[element.fieldName] = element.fieldValue;
             // console.log(element.fieldName + " has the value of " + result[element.fieldName])
                                                
          }             
      };              
      //console.log(result + " has the entries of " + Object.entries(result));
      return result;
  }
      
      // show the field values in the HTML
      //fieldscontainer.innerHTML = JSON.stringify(fieldValues, null, 2);

    export function renderPdf() {
      const pdfContainer = document.getElementById('pdf-container');
      // Loop through each page of the PDF document
      for (let pageNum = 1; pageNum <= pdfDoc.numPages; pageNum++) {
        // Get the page object for the current page
        pdfDoc.getPage(pageNum).then(page => {
          // Create a canvas element for rendering the page
          const canvas = document.createElement('canvas');
          const context = canvas.getContext('2d');
          canvas.style.border = '1px solid #ddd';
          pdfContainer.appendChild(canvas);
          
          // Get the viewport for the current page
          const viewport = page.getViewport({ scale: 1.5 });
          canvas.height = viewport.height;
          canvas.width = viewport.width;
          
          // Render the page onto the canvas
          page.render({ canvasContext: context, viewport });
        });
      }
    }

    export async function createForm() {
      if (!pdfDoc) return;

      pdfForm = await pdflib.PDFDocument.create();
      const pages = await pdfForm.copyPages(pdfDoc, Array.from({ length: pdfDoc.numPages }, (_, i) => i + 1));
      pages.forEach(page => pdfForm.addPage(page));

      const textField = pdfForm.createTextField('text-field');
      textField.setText('Type something');
      pdfForm.getPages()[0].getWidgets()[0].addTextField(textField);

      const modifiedPdfBytes = await pdfForm.save();
      downloadPdf(modifiedPdfBytes, 'modified.pdf');
    }

    export async function editForm() {
      if (!pdfForm) return;

      // Update form field values or perform other edits

      const modifiedPdfBytes = await pdfForm.save();
      downloadPdf(modifiedPdfBytes, 'modified.pdf');
    }

    export function downloadPdf(data, filename) {
      const blob = new Blob([data], { type: 'application/pdf' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();
    }
    
  </script>
  <ul class="flex items-center divide-x dark:text-white dark:divide-gray-700 text-gray-800 divide-gray-200">
    <h1 class="pl-3 pr-3 lg:pr-6 text-lg font-medium">Freightgate</h1>
  </ul>
  <input type="file" id="pdf-file-input" accept=".pdf"> </input>
  <div id = "selector" class="absolute xl:static  bottom-0 narrow:h-full vkeyboard:h-full md:h-full xl:border-r-2 xl:border-gray-100 xl:border-solid xl:dark:border-gray-1000 xl:dark:border-r z-10  h-[65%] translate-x-0">
    <button id="loadPdfBtn">Load PDF</button>
    <button id="createFormBtn">Create Form</button>
    <button id="editFormBtn">Edit Form</button>
  </div>
  <div id="pdf-container" class="flex flex-1 justify-center w-full bg-gray-100 h-full dark:bg-gray-950 overflow-hidden"></div>
  <div id = "fields-container"></div>
</body>
</html>
