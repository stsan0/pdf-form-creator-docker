<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDF Form Creator and Editor V2</title>
  <link rel="stylesheet" href="index.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>

<body>
  <!-- The Modal -->
  <div id="myModal" class="modal">

    <!-- Modal content -->

    <div class="modal-content">
      <span class="close">&times;</span>
      <div class="modal-title"></div>
      <div class="modal-body">Some text in the Modal..</div>
      <button class="modal-cancel">Cancel</button>
      <button class="modal-ok">OK</button>

      <div style="clear: both;"></div>
    </div>

  </div>
  <script type="text/javascript">
    var efb = null;
    // modal logic
    var modal = document.getElementById("myModal");

    // Get the button that opens the modal

    // Get the <span> element that closes the modal
    var span = document.getElementsByClassName("close")[0];

    // When the user clicks on the button, open the modal
    function openModal(text = 'Generic text', title = 'Element') {
      document.querySelector('.modal-title').innerHTML = title;
      document.querySelector('.modal-body').innerHTML = text;
      modal.style.display = "block";
    }

    // When the user clicks on <span> (x), close the modal
    span.onclick = function () {
      efb = null;
      modal.style.display = "none";
    }
    // When the user clicks anywhere outside of the modal, close it
    window.onclick = function (event) {
      if (event.target == modal) {
        efb = null;
        modal.style.display = "none";
      }
    }
    modalCancel = document.querySelector('.modal-cancel');
    modalOk = document.querySelector('.modal-ok');

    modalCancel.onclick = function () {
      efb = null;
      modal.style.display = "none";
    }
    modalOk.onclick = function () {
      //console.log(modal,modal.querySelector('#fontFamily').value);	
      if (efb.getAttribute('data-field') != modal.querySelector('#dataField').value) {
        efb.setAttribute('data-newtitle', modal.querySelector('#dataField').value);
      }
      efb.innerText = modal.querySelector('#innerText').value;
      // re-add the span "font-control fa fa-edit" to the element as a child
      efb.appendChild(document.createElement('span'));
      efb.lastChild.setAttribute('class', 'font-control fa fa-edit');
      efb.lastChild.addEventListener('click', function (e) {
        efb = e.target.parentElement;
        let mmodal = document.querySelector('.modal-body');
        // change the data-field of the modal to the editable-field's data-field using efb
        if (efb.getAttribute('data-field') == modal.querySelector('#dataField').value) {
          openModal(document.getElementById('fontControls').innerHTML, 'Editing ' + efb.getAttribute('data-field'));

          mmodal.querySelector('#dataField').value = efb.getAttribute('data-field');
        }
        if (efb.getAttribute('data-newtitle') != null) {
          openModal(document.getElementById('fontControls').innerHTML, 'Editing ' + efb.getAttribute('data-newtitle'));

          mmodal.querySelector('#dataField').value = efb.getAttribute('data-newtitle');
        }
        // change the innerText of the modal to the editable-field's innerText using efb
        mmodal.querySelector('#innerText').value = efb.innerText;
        console.log(" we are changing " + efb.getAttribute('data-field') + " and " + efb.innerText);

        mmodal.querySelector('#fontSize').value = efb.style.fontSize.replace('px', '');
        //console.log(efb.style.fontFamily);
        mmodal.querySelector('#fontColor').value = RGBToHex(efb.style.color);
        mmodal.querySelector('#fontFamily').value = efb.style.fontFamily.replace(/"/g, '');
        mmodal.querySelector('#fontStyle').value = efb.style.fontStyle;
        mmodal.querySelector('#fontWeight').value = efb.style.fontWeight;
        // get x y width height from efb
        let x = efb.style.left.replace('px', '');
        let y = efb.style.bottom.replace('px', '');
        let width = efb.style.width.replace('px', '');
        let height = efb.style.height.replace('px', '');
        //console.log(x + " " + y + " " + width + " " + height)
        mmodal.querySelector('#x').value = x;
        mmodal.querySelector('#y').value = y;
        mmodal.querySelector('#width').value = width;
        mmodal.querySelector('#height').value = height;
      });

      efb.style.fontSize = modal.querySelector('#fontSize').value + 'px';
      efb.style.color = modal.querySelector('#fontColor').value;
      efb.style.fontFamily = modal.querySelector('#fontFamily').value;
      efb.style.fontStyle = modal.querySelector('#fontStyle').value;
      efb.style.fontWeight = modal.querySelector('#fontWeight').value;

      // set the efb style x y width height
      efb.style.left = modal.querySelector('#x').value + 'px';
      efb.style.bottom = modal.querySelector('#y').value + 'px';
      efb.style.width = modal.querySelector('#width').value + 'px';
      efb.style.height = modal.querySelector('#height').value + 'px';
    }
    function aferIconCheck(e) {

      // First we get the pseudo-elements style
      const target = e.currentTarget || e.target
      const after = getComputedStyle(target, ":after")
      if (after) {
        // Then we parse out the dimensions
        const atop = Number(after.getPropertyValue("top").slice(0, -2))
        const aheight = Number(after.getPropertyValue("height").slice(0, -2))
        const aleft = Number(after.getPropertyValue("left").slice(0, -2))
        const awidth = Number(after.getPropertyValue("width").slice(0, -2))
        // And get the mouse position
        const ex = e.layerX
        const ey = e.layerY
        // Finally we do a bounds check (Is the mouse inside of the after element)
        if (ex > aleft && ex < aleft + awidth && ey > atop && ey < atop + aheight) {
          return true;
        }
        return false;
      }
    }
    function RGBToHex(rgb) {
      // Choose correct separator
      let sep = rgb.indexOf(",") > -1 ? "," : " ";
      // Turn "rgb(r,g,b)" into [r,g,b]
      rgb = rgb.substr(4).split(")")[0].split(sep);

      let r = (+rgb[0]).toString(16),
        g = (+rgb[1]).toString(16),
        b = (+rgb[2]).toString(16);

      if (r.length == 1)
        r = "0" + r;
      if (g.length == 1)
        g = "0" + g;
      if (b.length == 1)
        b = "0" + b;

      return "#" + r + g + b;
    }
    var greg = null;
  </script>
  <script src="scripts.js" type="module"></script>
  <ul>
    <h1 class="pl-3 pr-3 lg:pr-6 text-lg font-medium">
      <img src="logo-2-gray_b1314f12e2060642c2a7f9ceff48be9c-1.png" alt="Logo" loading="lazy" style="width: 200px;">
    </h1>
  </ul>

  <aside id="selector">
    <input type="file" id="pdf-file-input" accept=".pdf"> </input>
    <button id="loadPdfBtn">Load PDF</button>
    <button id="editFormBtn">Save Form</button>
  </aside>
  <aside id="pageControl">
    <button id="displayFieldsBtn">Show Fields</button>
    <button id="backBtn">
      <i class="fa fa-arrow-up"></i>
      Back
    </button>
    <button id="nextBtn">
      Next
      <i class="fa fa-arrow-down"></i>
    </button>
    <br></br>
    Pages:
    <div id="pageIndex"></div>/<div id="totalPageIndex"></div>
  </aside>

  <article id="pdf-container">
    <div id="canvas"></div> <!-- Holds all editable-text-fields -->
  </article>

  <aside id="toolbox">
    Drag'n'Drop to add fields
    <div id="toolbox-field" draggable="true" data-field="editable-field"
      style=" border-color: black; box-shadow: var(--focus-01); padding: 5px">
      Text Field</div>
    <div id="fontControls" style="visibility: hidden;">
      <label for="dataField"> Data Field: </label>
      <input type="text" id="dataField" value="dataField" style=" width: 99px">
      <label for="innerText"> Inner Text: </label>
      <input type="text" id="innerText" value="innerText" style=" width: 99px">
      <button class = "collapsible">Text Field Style</button>
      <div class = "content">
        <label for="fontSize">Font Size:</label>
        <select id="fontSize">
          <option value="0">Auto</option>
          <option value="4">4</option>
          <option value="6">6</option>
          <option value="8">8</option>
          <option value="10">10</option>
          <option value="12" selected>12</option>
          <option value="14">14</option>
          <option value="18">18</option>
          <option value="24">24</option>
          <option value="36">36</option>
          <option value="48">48</option>
          <option value="64">64</option>
          <option value="72">72</option>
          <option value="96">96</option>
          <option value="144">144</option>
          <option value="192">192</option>
          <option value="200">200</option>
        </select>
        <br></br>
        <label for="fontColor">Font Color:</label>
        <input type="color" id="fontColor" value="#000000">
        <br></br>
        <label for="fontStyle">Font Style:</label>
        <select id="fontStyle">
          <option value="normal">Normal</option>
          <option value="italic">Italic</option>
        </select>

        <select id="fontFamily" style=" width: 99px">
          <option value="Arial">Arial</option>
          <option value="Courier New">Courier New</option>
          <option value="Verdana">Verdana</option>
          <option value="Times New Roman">Times New Roman</option>
          <option value="Tahoma">Tahoma</option>
          <option value="sans-serif">sans-serif</option>
        </select>
        <select id="fontWeight">
          <option value="normal">Normal</option>
          <option value="bold">Bold</option>
          <option value="lighter">Lighter</option>
        </select>
      </div>
      <button class = "collapsible">Position</button>
      <div class = "content"><!-- get x y width height  -->
        <label for="x"> x: </label>
        <input type=number id="x" value="0" style=" width: 55px">
        <label for="y"> y: </label>
        <input type=number id="y" value="0" style=" width: 55px">
        <label for="width"> width: </label>
        <input type=number id="width" value="0" style=" width: 55px"> <br></br>
        <label for="height"> height: </label>
        <input type=number id="height" value="0" style=" width: 55px">
      </div>
    </div>
    <script>
         var coll = document.getElementsByClassName("collapsible");
    var i;
// todo: fix it fully opening on click of the button
  for (i = 0; i < coll.length; i++) {
    coll[i].addEventListener("click", function() {
      console.log(this);
      this.classList.toggle("active");
      var content = this.nextElementSibling;
      if (content.style.maxHeight){
        content.style.maxHeight = null;
      } else {
        content.style.maxHeight = content.scrollHeight + "px";
      } 
    });
  }    
    </script>
  </aside>
  <article id="fields-container"></article>
</body>

</html>